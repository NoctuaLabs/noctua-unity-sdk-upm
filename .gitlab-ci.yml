variables:
  NATIVE_IOS_VERSION: "0.27.0"
  NATIVE_IOS_ICM_VERSION: "0.27.1"
stages:
  - test
  - trigger
  - bump-version-for-release # Bump version as tag
  - publish # Publish to github

# Run tests on merge requests and main branch
test:
  stage: test
  tags:
    - local-shell  # Use runner with Unity installed (same as publish job)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "dev"
  variables:
    GIT_STRATEGY: clone
  artifacts:
    when: always
    paths:
      - testresults.xml
      - unity-test.log
      - CodeCoverage/
    reports:
      junit: testresults.xml
    expire_in: 30 days
  script:
    - echo "Running Unity tests with coverage..."
    - make test
  coverage: '/Line coverage:\s+(\d+\.\d+)%/'

trigger_job:
  stage: trigger
  trigger:
    project: $BUILDER_PROJECT
  rules:
    - when: never

.bump-version:
  image :
    name: alpine/git
    entrypoint: [""]
  before_script:
    # - apk add git-cliff
    # - apk add jq
    # - apk add curl
    - git config --global user.email "gitlab-ci@noctua.gg"
    - git config --global user.name "Noctua Gitlab CI"

bump-version-for-release:
  extends: .bump-version
  stage: bump-version-for-release
  tags:
    - local2
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_BRANCH == "ci"
  variables:
    GIT_STRATEGY: fetch # reuse workspace
    GIT_DEPTH: 0 # avoid shallow clone to give cliff all the info it needs
  artifacts:
    reports:
      dotenv: build.env
  script:
    - NEW_VERSION_TAG=$(git tag --list | sort -V | tail -n1 | awk '{v=$0; sub(/^[^0-9]*/, "", v); sub(/-.*/, "", v); split(v,a,"."); a[2]++; a[3]=0; printf "%d.%d.%d", a[1], a[2], a[3]}'); echo "$NEW_VERSION"
    - jq --arg version "$NEW_VERSION_TAG" '.version = $version' package.json > temp.json && mv temp.json package.json
    - |
      cat <<EOF > Runtime/AssemblyInfo.cs
      using System.Reflection;

      [assembly: AssemblyVersion("$NEW_VERSION_TAG")]
      EOF
    - if [ -n "$(git diff --name-only HEAD -- ./package.json)" ]; then
        echo "Bumping version for next release";
        git add package.json;
        git add Runtime/AssemblyInfo.cs;
        git commit -m "bump version to $NEW_VERSION_TAG [skip ci]";
        git push "https://$GITLAB_BUILDER_USER:$GITLAB_BUILDER_ACCESS_TOKEN@gitlab.com/evosverse/noctua/noctua-sdk-unity-upm.git" HEAD:$CI_COMMIT_BRANCH --follow-tags -o ci.skip;
      else
        echo "No version bump required";
      fi
    - echo "NEW_VERSION_TAG=$NEW_VERSION_TAG" > build.env
    - echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> build.env

# Publish to github
publish:
  stage: publish
  tags:
    - local-shell
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "ci"
  variables:
    GIT_STRATEGY: fetch # reuse workspace
    GIT_DEPTH: 0 # avoid shallow clone to give cliff all the info it needs
  needs: [bump-version-for-release]
  before_script:
    - git config --global user.email "gitlab-ci@noctua.gg"
    - git config --global user.name "Noctua Gitlab CI"
  script:
    # Prepare GitHub CLI tool
    #- curl -sS https://webi.sh/gh | sh # Already installed in local-shell runner
    #- source ~/.config/envman/PATH.env
    - gh auth status >/dev/null 2>&1 || echo "$GITHUB_ACCESS_TOKEN" | gh auth login --with-token
    # Refresh
    - git fetch origin
    - git checkout $COMMIT_HASH
    - git branch -D main || true
    # Update main branch on github repo
    - git checkout -b main
    - git remote add github https://github.com/NoctuaLabs/noctua-unity-sdk-upm.git || true
    - gh auth setup-git
    - git push github main || true
    # Push tag to github repo
    - git tag $NEW_VERSION_TAG || true
    - git push github $NEW_VERSION_TAG || true
    # Release
    - ./generate-release-note.sh
    - gh release create $NEW_VERSION_TAG --title $NEW_VERSION_TAG --notes-file GithubRelease.md
    - git remote remove github || true

# Publish ICM to github
publish-icm-version:
  stage: publish
  tags:
    - local-shell
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_BRANCH == "ci"
  variables:
    GIT_STRATEGY: fetch # reuse workspace
    GIT_DEPTH: 0 # avoid shallow clone to give cliff all the info it needs
  needs: [bump-version-for-release]
  before_script:
    - git config --global user.email "gitlab-ci@noctua.gg"
    - git config --global user.name "Noctua Gitlab CI"
  script:
    # Prepare GitHub CLI tool
    #- curl -sS https://webi.sh/gh | sh # Already installed in local-shell runner
    #- source ~/.config/envman/PATH.env
    - gh auth status >/dev/null 2>&1 || echo "$GITHUB_ACCESS_TOKEN" | gh auth login --with-token
    # Refresh
    - git fetch origin
    - git checkout $COMMIT_HASH
    - git branch -D main-icm || true
    - git checkout -b main-icm
    # Modify the version
    - sed -i -E '/Noctua/ s/(version=")[^"]+/\1'"$NATIVE_IOS_ICM_VERSION"'/' Editor/NativePluginDependencies.xml
    - sed -i 's/minTargetSdk="14.0"/minTargetSdk="15.0"/' Editor/NativePluginDependencies.xml
    - ./icm-version-suffix.sh
    - git add Editor/NativePluginDependencies.xml
    - git add package.json;
    - git add Runtime/AssemblyInfo.cs;
    - git commit -m "bump version to $NEW_VERSION_TAG-icm [skip ci]";
    # Tag
    - git tag $NEW_VERSION_TAG-icm || true
    # Push force to main-icm
    - git push "https://$GITLAB_BUILDER_USER:$GITLAB_BUILDER_ACCESS_TOKEN@gitlab.com/evosverse/noctua/noctua-sdk-unity-upm.git" main-icm -o ci.skip -f || true
    # Push tag
    - git push "https://$GITLAB_BUILDER_USER:$GITLAB_BUILDER_ACCESS_TOKEN@gitlab.com/evosverse/noctua/noctua-sdk-unity-upm.git" "$NEW_VERSION_TAG-icm" -o ci.skip || true
    # Update main branch on github repo
    - git remote add github https://github.com/NoctuaLabs/noctua-unity-sdk-upm.git || true
    - gh auth setup-git
    - git push github main-icm -f || true
    # Push tag to github repo
    - git push github $NEW_VERSION_TAG-icm || true
    # Release
    - ./generate-release-note.sh
    - gh release create $NEW_VERSION_TAG-icm --title $NEW_VERSION_TAG-icm --notes-file GithubRelease.md
    - git remote remove github || true
